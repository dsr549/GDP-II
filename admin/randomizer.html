<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="ISHA.css">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="TemplateMo">
  <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700,800,900" rel="stylesheet">

  <title>Horse and Riders Page</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">


  <!-- Additional CSS Files -->
  <link rel="stylesheet" href="assets/css/fontawesome.css">
  <link rel="stylesheet" href="assets/css/templatemo-edu-meeting.css">
  <link rel="stylesheet" href="assets/css/owl.css">
  <link rel="stylesheet" href="assets/css/lightbox.css">

  <style>
    /* Custom section for announcements */
    .announcements {
      margin-top: 40px;
    }

    .announcement-item {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e9ecef;
    }

    .announcement-content h3 {
      margin-bottom: 10px;
      font-size: 20px;
    }

    .announcement-content p {
      margin-bottom: 0;
    }

    .announcement-date {
      text-align: right;
      margin-top: 10px;
      font-size: 14px;
      color: #888;
    }

    /* Custom buttons */
    .announcement-buttons {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .announcement-buttons button {
      margin-left: 10px;
    }

    /* Custom styling for nav */
    .main-nav {
      background-color: rgba(7, 7, 7, 0.15);
    }

    .announcement-header-area {
      background-color: rgba(7, 7, 7, 0.15);
      position: relative;
      left: 0;
      right: 0;
      z-index: 100;
      -webkit-transition: all .5s ease 0s;
      -moz-transition: all .5s ease 0s;
      -o-transition: all .5s ease 0s;
      transition: all .5s ease 0s;
    }
    /* Custom styling for table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f2f2f2;
    }
   .btn {
        display: inline-block;
        padding: 10px 20px;
        background-color: #4CBA17;
        color: #fff;
        text-decoration: none;
        border-radius: 5px;
        transition: background-color 0.3s ease;
      }

      .btn:hover {
        background-color: #4CBB17;
      }


/* footer */
.footer {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        height: 150px;
        position: relative;
        bottom: 0;
        width: 100%;
    }

    .footer .social a{

        margin-right: 20px;
        color: #4CBB17;
    }

    .footer .social a:hover{
        color: #fff;
        background-image: linear-gradient(45deg, #32be8f 0%, #38d39f 510%, #32be8f 100%);
    }
    .class-table {
            display: none;
    }

    .active-table {
        display: table;
    }
</style>
<script src="https://kit.fontawesome.com/f52c3b31f3.js" crossorigin="anonymous"></script>
<script src="js/auth.js"></script>
<script src="js/logout.js"></script>
</head>

<body>

  <!-- Sub Header -->


 <!-- ***** Header Area Start ***** -->
 <header class="announcement-header-area" style="background-color: #444; height: 150px;">
  <!--<div class="sub-header">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-sm-8">
          <div class="left-content">
          </div>
        </div>
        <div class="col-lg-4 col-sm-4">
          <div class="right-icons">
            <ul>
              <li><a href="#"><i class="fa fa-facebook"></i></a></li>
              <li><a href="#"><i class="fa fa-twitter"></i></a></li>
              <li><a href="#"><i class="fa fa-instagram"></i></a></li>
              <li><a href="#"><i class="fa fa-linkedin"></i></a></li>
            </ul>
            
          </div>
          
        </div>
      </div>
    </div>
  </div>-->
    <div class="container">
      <div class="row">
        <div class="col-12">
          <nav class="main-nav">
            <a href="index.html" class="logo">
              InterCollegiate Horse Shows Association
            </a>
            <!-- ***** Menu Start ***** -->
            <ul class="nav" style="margin-top: 40px !important;">
              <li class="scroll-to-section"><a href="announcements.html">Announcement</a></li>
              <li class="scroll-to-section"><a href="dataUpload.html">Horse/Rider Info</a></li>
              <li class="scroll-to-section"><a class="active" href="randomizer.html">Randomizer</a></li>
              <li class="scroll-to-section"><a href="maps.html">Maps</a></li>
              <li class="scroll-to-section"><a href="contactuspage.html">Contact Us</a></li>
              <li class="scroll-to-section"><a href="gallerypage.html">Gallery</a></li>
              <button id="logout" style="margin-right: 0px !important; background-color: #0b5ed7 !important; margin-left: 60px !important;" type="button" onclick="logout()" class="btn btn-primary">LOGOUT</button>
            </ul>
            <a class='menu-trigger'>
              <span>Menu</span>
            </a>
            <!-- ***** Menu End ***** -->
          </nav>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="section-heading">
          <h2>Randomizer</h2>
        </div>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
  
        <div class="section-heading">
          <label for="class">Select Class:</label>
          <select id="class">
              <option hidden>Select a Class</option>
          </select>
          <button id="show-all">Show All Classes</button>
          <button id="randomize" style="display: none;">Randomize</button>
          <button id="randomizeAll">Randomize All</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="table-responsive">
             <!-- Container to hold the tables for each class -->
             <div id="table-container"></div>
        </div>
      </div>
    </div>
  </div>



<div class="container">
    <div class="row">
      <div class="col-lg-12">
        <button style="margin-left: 45%; margin-top: 30px;" class="btn" id="save-combinations">Save Generated</button>
      </div>
    </div>
</div>
  <footer class="footer bg-dark" id="footer" style="bottom: 0 !important; background:#444;">
    <div class="social">
      <a href="https://www.facebook.com" target="_blank"><i class="fa-brands fa-facebook fa-2x"></i></a>
          <a href="https://www.twitter.com" target="_blank"><i class="fab fa-twitter fa-2x"></i></a>
          <a href="https://www.youtube.com" target="_blank"><i class="fab fa-youtube fa-2x"></i></a>
          <a href="https://www.linkedin.com" target="_blank"><i class="fab fa-linkedin fa-2x"></i></a>
    </div>
    <p>copyright &copy 2023 - IHSA</p>
</footer>
<script>
document.addEventListener("DOMContentLoaded", async function () {
  var result = await fetch('/admin/api/getData', {
          method: 'GET',
          headers: {
              'Accept': 'application/json'
          }
      })
      .then((res) => res.json());
     console.log(result);
    const classSelect = document.getElementById("class");
      const uniqueClasses = [...new Set(result.Rlist.map(item => item.class))];
      uniqueClasses.forEach(className => {
          const option = document.createElement("option");
          option.value = className;
          option.text = className;
          classSelect.appendChild(option);
      });
      const randomizedData = {};
      function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]];
          }
      }

      function populateTable(selectedClass) {
  const tableContainer = document.getElementById("table-container");
  const filteredRiders = result.Rlist.filter((item) => item.class === selectedClass);
  const horseDataForClass = result.Hlist.filter(item => item.class && selectedClass.includes(item.class));


  const ohOwRiders = filteredRiders.filter((rider) => rider.oh_ow === 1);
  const regularRiders = filteredRiders.filter((rider) => rider.oh_ow === 0);

 
  const strongHorses = horseDataForClass.filter((horse) => horse.isStrong === 1);
  const regularHorses = horseDataForClass.filter((horse) => horse.isStrong === 0 || horse.isStrong === 1);

  const shuffledStrongHorses = [...strongHorses];
  shuffleArray(shuffledStrongHorses);

  const shuffledRegularHorses = [...regularHorses];
  shuffleArray(shuffledRegularHorses);

  const table = document.createElement("table");
  table.className = `class-table ${selectedClass}-table active-table`;
  let order = 1;
  table.innerHTML = `
    <thead>
      <tr>
        <th colspan="6">${selectedClass}</th>
      </tr>
      <tr>
        <th>Order</th>
        <th>Rider ID</th>
        <th>Rider Name</th>
        <th>Rider School</th>
        <th>Horse Name</th>
        <th>Provider</th>
      </tr>
    </thead>
    <tbody>
      ${ohOwRiders.map((rider, index) => {
        if (index < shuffledStrongHorses.length) {
          const horse = shuffledStrongHorses[index];
          
          const horseIndex = shuffledRegularHorses.findIndex((h) =>  h.ID === horse.ID );
          if (horseIndex !== -1) {
            shuffledRegularHorses.splice(horseIndex, 1);
          }
          return `
            <tr>
              <td>${order++}</td>
              <td>${rider.riderid}</td>
              <td>${rider.name}</td>
              <td>${rider.school}</td>
              <td>${horse.name}</td>
              <td>${horse.provider}</td>
            </tr>
          `;
        }
        return `
          <tr>
            <td>${order++}</td>
            <td>${rider.riderid}</td>
            <td>${rider.name}</td>
            <td>${rider.school}</td>
            <td>-</td>
            <td>-</td>
          </tr>
        `;
      }).join('')}
      ${regularRiders.map((rider, index) => {
        if (index < shuffledRegularHorses.length) {
          const horse = shuffledRegularHorses[index];
          return `
            <tr>
              <td>${order++}</td>
              <td>${rider.riderid}</td>
              <td>${rider.name}</td>
              <td>${rider.school}</td>
              <td>${horse.name}</td>
              <td>${horse.provider}</td>
            </tr>
          `;
        }
        return `
          <tr>
            <td>${order++}</td>
            <td>${rider.riderid}</td>
            <td>${rider.name}</td>
            <td>${rider.school}</td>
            <td>-</td>
            <td>-</td>
          </tr>
        `;
      }).join('')}
    </tbody>
  `;

  tableContainer.appendChild(table);
}




      function clearAllTables() {
          const tableContainer = document.getElementById("table-container");
          tableContainer.innerHTML = ""; 
      }
      uniqueClasses.forEach(className => {
          populateTable(className);
      });
  
  classSelect.addEventListener("change", () => {
      const selectedClass = classSelect.value;
      clearAllTables();
      if (selectedClass !== "Select a Class") {
          populateTable(selectedClass);
          document.getElementById("randomize").style.display = "block";
          document.getElementById("randomizeAll").style.display = "none";
        //  document.getElementById("save-combinations").style.display = "none";
      } else {
          document.getElementById("randomize").style.display = "none";
          document.getElementById("randomizeAll").style.display = "block";
          document.getElementById("save-combinations").style.display = "block";
      }
  });
  
  document.getElementById("show-all").addEventListener("click", () => {
      clearAllTables(); 
      uniqueClasses.forEach(className => {
          populateTable(className); 
      });
      document.getElementById("randomizeAll").style.display = "block";
      document.getElementById("save-combinations").style.display = "block";
      document.getElementById("randomize").style.display = "none";
      classSelect.value = "Select a Class";
  });
document.getElementById("randomizeAll").addEventListener("click", () => {
    clearAllTables(); 
    const horseDataCopy = [...result.Hlist];
    uniqueClasses.forEach(className => {
        populateTable(className, horseDataCopy); 
    });
});
document.getElementById("randomize").addEventListener("click", () => {
    const selectedClass = classSelect.value;
    clearAllTables(); 
    const horseDataCopy = [...result.Hlist];
    populateTable(selectedClass, horseDataCopy); 
});
  

document.getElementById("save-combinations").addEventListener("click", () => {
        const allTables = document.querySelectorAll(".class-table");
        tablesToExcel(Array.from(allTables).map(table => table.outerHTML), "ihsa-randomizer-data");
    }); 
  });

function tablesToExcel(tables, sheetName) {
    const uri = 'data:application/vnd.ms-excel;base64,';
    const template = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
        <head>
            <!--[if gte mso 9]>
            <xml>
                <x:ExcelWorkbook>
                    <x:ExcelWorksheets>
                        <x:ExcelWorksheet>
                            <x:Name>{worksheet}</x:Name>
                            <x:WorksheetOptions>
                                <x:DisplayGridlines/>
                            </x:WorksheetOptions>
                        </x:ExcelWorksheet>
                    </x:ExcelWorksheets>
                </x:ExcelWorkbook>
            </xml>
            <![endif]-->
        </head>
        <body>
            {tables}
        </body>
        </html>`;
    const base64 = function(s) {
        return window.btoa(unescape(encodeURIComponent(s)));
    };
    const format = function(s, c) {
        return s.replace(/{(\w+)}/g, function(m, p) {
            return c[p];
        });
    };
    const ctx = {
        worksheet: sheetName,
        tables: tables
    };
    const blob = new Blob([format(template, ctx)], { type: 'application/vnd.ms-excel' });
    const link = document.createElement('a');
    link.href = uri + base64(format(template, ctx));
    link.download = `${sheetName}.xls`;
    link.click();
  
  
  
  }



 </script>
</body>

</html>